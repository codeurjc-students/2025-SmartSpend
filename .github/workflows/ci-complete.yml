name: CI - Complete Quality Check

on:
  pull_request:
    branches: [ "main" ]

env:
  SPRING_PROFILES_ACTIVE: prod

jobs:
  backend-complete:
    runs-on: ubuntu-latest
    name: Backend Complete Quality Check
    env:
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    steps:
      - uses: actions/checkout@v4

      - name: Create Keystore from Secret for Backend
        env:
          KEYSTORE_P12_BASE64: ${{ secrets.KEYSTORE_P12_BASE64 }}
        run: |
          echo "Creating keystore file from secret for backend..."
          echo "${KEYSTORE_P12_BASE64}" | base64 --decode > backend/src/main/resources/keystore.p12
          echo "Keystore file created successfully."

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 21

      - name: Build backend
        working-directory: backend
        run: mvn clean compile -B

      - name: Run backend unit tests
        working-directory: backend
        run: mvn test -Dtest="*Unit*,*ServiceTest*" -Dsurefire.failIfNoSpecifiedTests=false -B

      - name: Integration and E2E Tests Status
        run: |
          echo "ðŸš§ Integration and E2E Tests Status ðŸš§"
          echo ""
          echo "The following tests are temporarily disabled while authentication functionality is completed:"
          echo "âŒ Integration Tests (JVM-based, require JWT authentication)"
          echo "âŒ E2E Selenium Tests (require full login flow)"
          echo ""
          echo "API Integration Tests (Postman/Newman) are now enabled and will run in a separate job using Docker Compose."
          echo "âœ… Only backend unit tests are active in this job."

  postman-api-tests:
    runs-on: ubuntu-latest
    name: Postman API Tests (Newman with Docker Compose)
    needs: [backend-complete]
    env:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 21

      - name: Create Keystore from Secret for Backend Docker Image
        env:
          KEYSTORE_P12_BASE64: ${{ secrets.KEYSTORE_P12_BASE64 }}
        run: |
          echo "Creating keystore file from secret for backend image build..."
          echo "${KEYSTORE_P12_BASE64}" | base64 --decode > backend/src/main/resources/keystore.p12
          echo "Keystore file created successfully."

      - name: Build and Package Backend
        working-directory: backend
        run: mvn clean package -DskipTests -B

      - name: Build Backend Docker Image
        run: |
          docker build -t ${DOCKER_HUB_USERNAME}/smartspend:dev -f docker/Dockerfile .

      - name: Run Docker Compose Services and Newman Tests
        working-directory: docker
        run: |
          docker-compose -f docker-compose-ci.yml up --build --abort-on-container-exit --exit-code-from newman

      - name: Upload Newman Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: newman-test-report
          path: postman/newman-report.xml

      - name: Show Docker Compose Logs on Failure
        if: failure()
        run: |
          echo "--- Docker Compose Logs ---"
          echo "Refer to the 'Run Docker Compose Services and Newman Tests' step for detailed logs."

  quality-gate:
    runs-on: ubuntu-latest
    name: Quality Gate
    needs: [backend-complete, postman-api-tests]
    
    steps:
      - name: Quality Gate Passed
        run: |
          echo "âœ… Quality Gate PASSED"
          echo ""
          echo "ðŸ“‹ Executed Tests Summary:"
          echo "  âœ… Backend Unit Tests: PASSED"
          echo "  âœ… Postman API Integration Tests: PASSED (via Docker Compose)"
          echo "  ðŸš§ Backend Integration Tests (JVM-based): SKIPPED (temporary)"
          echo "  ðŸš§ E2E Tests: SKIPPED (temporary)"
          echo ""
          echo "ðŸš€ Ready to merge! Continue with feature development."