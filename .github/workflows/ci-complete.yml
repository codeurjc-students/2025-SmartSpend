name: CI - Complete Quality Check

on:
  pull_request:
    branches: [ "main" ]

env:
  SPRING_PROFILES_ACTIVE: prod

jobs:
  backend-complete:
    runs-on: ubuntu-latest
    name: Backend Complete Quality Check
    env:
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    steps:
      - uses: actions/checkout@v4

      # Creates the keystore file from a secret for integration tests.
      - name: Create Keystore from Secret for Backend
        env:
          KEYSTORE_P12_BASE64: ${{ secrets.KEYSTORE_P12_BASE64 }}
        run: |
          echo "Creating keystore file from secret for backend..."
          echo "${KEYSTORE_P12_BASE64}" | base64 --decode > backend/src/main/resources/keystore.p12
          echo "Keystore file created successfully."

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 21

      - name: Build backend
        working-directory: backend
        run: mvn clean compile -B

      - name: Run backend unit tests
        working-directory: backend
        run: mvn test -Dtest="*Unit*,*ServiceTest*" -Dsurefire.failIfNoSpecifiedTests=false -B

      - name: Integration and E2E Tests Status
        run: |
          echo "ðŸš§ Integration and E2E Tests Status ðŸš§"
          echo ""
          echo "The following tests are temporarily disabled while authentication functionality is completed:"
          echo "âŒ Integration Tests (JVM-based, require JWT authentication)"
          echo "âŒ E2E Selenium Tests (require full login flow)"
          echo ""
          echo "API Integration Tests (Postman/Newman) are now enabled and will run in a separate job."
          echo "âœ… Only backend unit tests are active in this job."

  postman-api-tests:
    runs-on: ubuntu-latest
    name: Postman API Tests (Newman)
    needs: [backend-complete]
    env:
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    steps:
      - uses: actions/checkout@v4

      # Creates the keystore file from a secret for the backend to use.
      - name: Create Keystore from Secret for Backend
        env:
          KEYSTORE_P12_BASE64: ${{ secrets.KEYSTORE_P12_BASE64 }}
        run: |
          echo "Creating keystore file from secret for backend..."
          echo "${KEYSTORE_P12_BASE64}" | base64 --decode > backend/src/main/resources/keystore.p12
          echo "Keystore file created successfully."

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 21

      - name: Build backend
        working-directory: backend
        # Skip tests to avoid re-running unit tests already covered in backend-complete
        run: mvn clean install -DskipTests -B

      - name: Start Backend and Wait for Health
        working-directory: backend
        run: |
          nohup mvn spring-boot:run -Dspring-boot.run.profiles=ssl > backend.log 2>&1 &
          echo "Waiting for backend to become healthy on HTTPS..."
          # Health check hitting the login endpoint to ensure the application is responsive
          timeout 90 bash -c 'until curl --fail --insecure https://localhost:8443/api/v1/auth/login; do sleep 5; done'
          echo "Backend is up and running on HTTPS."

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Newman and JUnit Reporter
        run: npm install -g newman newman-reporter-junit

      - name: Run Postman API Tests with Newman
        working-directory: postman
        run: |
          echo "Executing Postman API tests using Newman..."
          newman run "postman_collection.json" \
            -e "SmartSpend-Environment-CI.postman_environment.json" \
            --insecure \
            --reporters cli,junit \
            --reporter-junit-export "newman-report.xml" \
            --timeout-request 30000 \
            --timeout-script 10000

      - name: Upload Newman Test Report
        uses: actions/upload-artifact@v4
        if: always() # Upload report even if tests fail
        with:
          name: newman-test-report
          path: postman/newman-report.xml

      - name: Show Backend Logs on Failure
        if: failure()
        run: |
          echo "--- Backend logs (last 100 lines) ---"
          tail -n 100 backend/backend.log

  quality-gate:
    runs-on: ubuntu-latest
    name: Quality Gate
    needs: [backend-complete, postman-api-tests]
    
    steps:
      - name: Quality Gate Passed
        run: |
          echo "âœ… Quality Gate PASSED"
          echo ""
          echo "ðŸ“‹ Executed Tests Summary:"
          echo "  âœ… Backend Unit Tests: PASSED"
          echo "  âœ… Postman API Integration Tests: PASSED"
          echo "  ðŸš§ Backend Integration Tests (JVM-based): SKIPPED (temporary)"
          echo "  ðŸš§ E2E Tests: SKIPPED (temporary)"
          echo ""
          echo "ðŸš€ Ready to merge! Continue with feature development."