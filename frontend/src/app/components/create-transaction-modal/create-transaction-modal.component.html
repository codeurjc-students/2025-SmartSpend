<!-- MODAL BACKDROP -->
<div
  *ngIf="isVisible"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
  (click)="close()"
>

  <!-- MODAL -->
  <div
    class="w-full max-w-2xl bg-slate-800 rounded-2xl shadow-xl
           max-h-[90vh] flex flex-col"
    (click)="$event.stopPropagation()"
  >

    <!-- HEADER (FIJO) -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-700">
      <h2 class="text-lg font-semibold text-slate-100">
        ðŸ’° Nueva TransacciÃ³n
      </h2>

      <div class="flex items-center gap-3">
        <button
          type="button"
          (click)="close()"
          class="px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-500 transition text-sm"
          [disabled]="isLoading"
        >
          Cancelar
        </button>

        <button
          type="submit"
          form="transactionForm"
          class="px-4 py-2 rounded-lg text-sm font-medium transition-all
         flex items-center gap-2
         bg-indigo-500 text-white
         disabled:bg-slate-600 disabled:text-slate-300
         disabled:cursor-not-allowed
         enabled:hover:bg-indigo-600
         enabled:shadow-md enabled:shadow-indigo-500/25"
  [disabled]="!isFormValid() || isLoading"
        >
          <span
            *ngIf="isLoading"
            class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"
          ></span>
          {{ isLoading ? 'Creando...' : 'Crear' }}
        </button>

        <button
          (click)="close()"
          class="text-slate-400 hover:text-slate-200 transition text-xl ml-1"
        >
          âœ•
        </button>
      </div>
    </div>

    <!-- BODY (SCROLLABLE) -->
    <div class="px-6 py-5 overflow-y-auto overflow-x-hidden flex-1">

      <!-- ERROR -->
      <div *ngIf="errorMessage" class="mb-4">
        <p class="text-sm text-red-400">{{ errorMessage }}</p>
      </div>

      <!-- FORM -->
      <form
        id="transactionForm"
        (ngSubmit)="onSubmit()"
        #transactionForm="ngForm"
        class="grid grid-cols-1 md:grid-cols-2 gap-5"
      >

        <!-- Cuenta (readonly) -->
        <div class="md:col-span-2">
          <label class="block text-sm text-slate-400 mb-1">
            Cuenta
          </label>
          <div class="px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-slate-300 opacity-80">
            {{ currentAccount?.accountName || 'Sin cuenta seleccionada' }}
          </div>
        </div>

        <!-- TÃ­tulo -->
        <div>
          <label class="block text-sm text-slate-400 mb-1">
            TÃ­tulo <span class="text-red-400">*</span>
          </label>
          <input
            type="text"
            [(ngModel)]="newTransaction.title"
            name="title"
            required
            maxlength="30"
            placeholder="Ej: Supermercado, NÃ³mina..."
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2
                   text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
        </div>

        <!-- Tipo -->
        <!-- Tipo -->
        <!-- Tipo -->
        <div>
          <label class="block text-sm text-slate-400 mb-2">
            Tipo <span class="text-red-400">*</span>
          </label>

          <div class="grid grid-cols-2 gap-4">
            <!-- GASTO -->
            <button
              type="button"
              (click)="newTransaction.type='EXPENSE'; onTransactionTypeChange()"
              class="flex items-center justify-center gap-2
                    px-3 py-2.5 rounded-lg border text-sm font-medium
                    transition-all"
              [ngClass]="{
                'bg-red-500/15 border-red-500 text-red-400 ring-1 ring-red-500/40':
                  newTransaction.type === 'EXPENSE',
                'bg-slate-900 border-slate-700 text-slate-400 hover:bg-slate-800':
                  newTransaction.type !== 'EXPENSE'
              }"
            >
              ðŸ’¸ Gasto
            </button>

            <!-- INGRESO -->
            <button
              type="button"
              (click)="newTransaction.type='INCOME'; onTransactionTypeChange()"
              class="flex items-center justify-center gap-2
                    px-3 py-2.5 rounded-lg border text-sm font-medium
                    transition-all"
              [ngClass]="{
                'bg-green-500/15 border-green-500 text-green-400 ring-1 ring-green-500/40':
                  newTransaction.type === 'INCOME',
                'bg-slate-900 border-slate-700 text-slate-400 hover:bg-slate-800':
                  newTransaction.type !== 'INCOME'
              }"
            >
              ðŸ’° Ingreso
            </button>
          </div>
        </div>


        <!-- CategorÃ­a -->
        <div>
          <label class="block text-sm text-slate-400 mb-1">
            CategorÃ­a <span class="text-red-400">*</span>
          </label>

          <div *ngIf="isLoadingCategories" class="py-4 text-center text-slate-400">
            Cargando categorÃ­as...
          </div>

          <select
            *ngIf="!isLoadingCategories"
            [(ngModel)]="newTransaction.categoryId"
            name="categoryId"
            required
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2
                   text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          >
            <option
              *ngFor="let category of availableCategories"
              [value]="category.id"
            >
              {{ category.icon }} {{ category.name }}
            </option>
          </select>
        </div>

        <!-- Cantidad -->
        <div>
          <label class="block text-sm text-slate-400 mb-1">
            Cantidad <span class="text-red-400">*</span>
          </label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-semibold">
              â‚¬
            </span>
            <input
              type="number"
              [(ngModel)]="newTransaction.amount"
              name="amount"
              step="0.01"
              min="0.01"
              placeholder="0.00"
              (focus)="onAmountFocus()"
              required
              class="w-full pl-8 rounded-lg bg-slate-900 border border-slate-700 px-3 py-2
                     text-slate-200 text-right font-semibold
                     focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
          </div>
        </div>

        <!-- Fecha -->
        <div>
          <label class="block text-sm text-slate-400 mb-1">
            Fecha
          </label>
          <input
            type="date"
            [(ngModel)]="newTransaction.date"
            name="date"
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2
                   text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
          <p class="text-xs text-slate-500 mt-1">
            Si no eliges fecha, se usarÃ¡ la actual
          </p>
        </div>

        <!-- Recurrencia -->
        <div>
          <label class="block text-sm text-slate-400 mb-1">
            Recurrencia
          </label>
          <select
            [(ngModel)]="newTransaction.recurrence"
            name="recurrence"
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2
                   text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          >
            <option value="NONE">Sin recurrencia</option>
            <option value="DAILY">Diaria</option>
            <option value="WEEKLY">Semanal</option>
            <option value="MONTHLY">Mensual</option>
            <option value="YEARLY">Anual</option>
          </select>
        </div>

        <!-- DescripciÃ³n -->
        <div class="md:col-span-2">
          <label class="block text-sm text-slate-400 mb-1">
            DescripciÃ³n
          </label>
          <textarea
            [(ngModel)]="newTransaction.description"
            name="description"
            rows="3"
            maxlength="100"
            placeholder="DescripciÃ³n opcional"
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2
                   text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          ></textarea>
          <p class="text-xs text-slate-500 mt-1">
            MÃ¡ximo 100 caracteres
          </p>
        </div>

        <!-- Imagen -->
        <div class="md:col-span-2">
          <label class="block text-sm text-slate-400 mb-2">
            ðŸ“· Imagen (Opcional)
          </label>
          
          <!-- Input de archivo -->
          <div class="mb-3">
            <input
              id="imageInput"
              type="file"
              accept="image/*"
              (change)="onImageSelected($event)"
              class="hidden"
            />
            
            <!-- BotÃ³n para seleccionar archivo -->
            <button
              type="button"
              (click)="openFileSelector()"
              class="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 
                     border border-slate-600 rounded-lg text-slate-200 transition-colors"
            >
              ðŸ“Ž Seleccionar imagen
            </button>
            
            <!-- InformaciÃ³n del archivo -->
            <p class="text-xs text-slate-500 mt-1">
              Formatos: JPG, PNG, WebP. TamaÃ±o mÃ¡ximo: 5MB
            </p>
          </div>

          <!-- Error de imagen -->
          <div *ngIf="imageError" class="mb-3">
            <p class="text-sm text-red-400 bg-red-500/10 border border-red-500/20 rounded-lg p-2">
              {{ imageError }}
            </p>
          </div>

          <!-- Preview de imagen -->
          <div *ngIf="imagePreview" class="mb-3">
            <div class="relative inline-block">
              <img
                [src]="imagePreview"
                alt="Vista previa"
                class="max-w-xs max-h-32 rounded-lg border border-slate-600"
              />
              <!-- BotÃ³n para quitar imagen -->
              <button
                type="button"
                (click)="clearImage()"
                class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full
                       hover:bg-red-600 transition-colors text-xs font-bold"
              >
                âœ•
              </button>
            </div>
            <p class="text-xs text-slate-400 mt-1">
              {{ selectedImageFile?.name }}
            </p>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>
