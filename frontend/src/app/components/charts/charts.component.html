<div class="bg-slate-800 min-h-screen text-slate-200 p-6">
  <div class="max-w-7xl mx-auto">
    
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-2">Análisis Financiero</h1>
      <p class="text-slate-400">
        Visualiza tus patrones de gasto e ingresos - 
        <span class="font-medium">
          {{ viewType === 'monthly' ? (getMonthName(selectedMonth) + ' ' + selectedYear) : 'Año ' + selectedYear }}
        </span>
      </p>
    </div>

    <!-- Loading State -->
    <div *ngIf="loadingPieIncomes || loadingPieExpenses || loadingBarChart || loadingTimelineChart" class="flex items-center justify-center min-h-[400px]">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
        <p class="text-slate-400">Cargando gráficos...</p>
      </div>
    </div>

    <!-- Content -->
    <div *ngIf="!loadingPieIncomes && !loadingPieExpenses && !loadingBarChart && !loadingTimelineChart">
      
      <!-- Controls -->
      <div class="bg-slate-700 rounded-lg p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
          
          <!-- Selector de período -->
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
              Período
            </label>
            <select 
              [(ngModel)]="viewType"
              (ngModelChange)="onViewTypeChange()"
              class="w-full p-2 bg-slate-600 border border-slate-500 rounded-lg text-slate-200 focus:ring-2 focus:ring-blue-500">
              <option value="monthly">Mensual</option>
              <option value="yearly">Anual</option>
            </select>
          </div>
          
          <!-- Selector de cuenta -->
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
              Cuenta Bancaria
            </label>
            <select 
              [(ngModel)]="selectedAccountId"
              (ngModelChange)="onAccountChange()"
              class="w-full p-2 bg-slate-600 border border-slate-500 rounded-lg text-slate-200 focus:ring-2 focus:ring-blue-500">
              <option *ngFor="let account of bankAccounts" [value]="account.id">
                {{ account.accountName }} - €{{ account.currentBalance }}
              </option>
            </select>
          </div>

          <!-- Selector de año -->
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
              Año
            </label>
            <select 
              [(ngModel)]="selectedYear"
              (ngModelChange)="onDateChange()"
              class="w-full p-2 bg-slate-600 border border-slate-500 rounded-lg text-slate-200 focus:ring-2 focus:ring-blue-500">
              <option [value]="currentYear - 1">{{ currentYear - 1 }}</option>
              <option [value]="currentYear">{{ currentYear }}</option>
              <option [value]="currentYear + 1">{{ currentYear + 1 }}</option>
            </select>
          </div>

          <!-- Selector de mes (solo si es mensual) -->
          <div *ngIf="viewType === 'monthly'">
            <label class="block text-sm font-medium text-slate-300 mb-2">
              Mes
            </label>
            <select 
              [(ngModel)]="selectedMonth"
              (ngModelChange)="onDateChange()"
              class="w-full p-2 bg-slate-600 border border-slate-500 rounded-lg text-slate-200 focus:ring-2 focus:ring-blue-500">
              <option *ngFor="let month of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="month">
                {{ getMonthName(month) }}
              </option>
            </select>
          </div>

          <!-- Espacio vacío si es anual -->
          <div *ngIf="viewType === 'yearly'"></div>

          <!-- Botón actualizar -->
          <div class="flex items-end">
            <button 
              (click)="loadCharts()" 
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors mb-2">
              Actualizar
            </button>
          </div>

          <!-- Botón generar PDF (solo para vista mensual) -->
          <div *ngIf="viewType === 'monthly'" class="flex items-end">
            <button 
              (click)="generateMonthlyPdf()" 
              [disabled]="generatingPdf"
              class="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
              <svg *ngIf="generatingPdf" class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              {{ generatingPdf ? 'Generando...' : 'Generar PDF' }}
            </button>
          </div>

          <!-- Espacio vacío si es anual -->
          <div *ngIf="viewType === 'yearly'"></div>
          
        </div>
      </div>

      <!-- Charts Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        
        <!-- Income Pie Chart -->
        <div class="bg-slate-700 rounded-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-slate-200">Ingresos por Categoría</h3>
            <span *ngIf="pieIncomesData" class="bg-green-600 text-white px-3 py-1 rounded-full text-sm">
              Total: €{{ incomeTotal }}
            </span>
          </div>
          
          <div class="h-80 flex items-center justify-center">
            <div *ngIf="pieIncomesData" class="w-full h-full">
              <canvas baseChart
                [data]="pieIncomesData"
                [type]="'pie'"
                [options]="pieChartOptions">
              </canvas>
            </div>
            <div *ngIf="!pieIncomesData" class="text-center text-slate-400">
              <p>No hay ingresos en el período seleccionado</p>
            </div>
          </div>
        </div>

        <!-- Expense Pie Chart -->
        <div class="bg-slate-700 rounded-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-slate-200">Gastos por Categoría</h3>
            <span *ngIf="pieExpensesData" class="bg-red-600 text-white px-3 py-1 rounded-full text-sm">
              Total: €{{ expenseTotal }}
            </span>
          </div>
          
          <div class="h-80 flex items-center justify-center">
            <div *ngIf="pieExpensesData" class="w-full h-full">
              <canvas baseChart
                [data]="pieExpensesData"
                [type]="'pie'"
                [options]="pieChartOptions">
              </canvas>
            </div>
            <div *ngIf="!pieExpensesData" class="text-center text-slate-400">
              <p>No hay gastos en el período seleccionado</p>
            </div>
          </div>
        </div>

      </div>

      <!-- Timeline Chart Full Width -->
      <div class="bg-slate-700 rounded-lg p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-slate-200">
            Evolución Temporal del Balance
            <span class="text-sm text-slate-400 font-normal ml-2">
              ({{ viewType === 'monthly' ? 'Día a día' : 'Mes a mes' }})
            </span>
          </h3>
          <div class="flex space-x-4 text-sm">
            <span class="flex items-center">
              <div class="w-3 h-3 bg-sky-400 rounded-full mr-1"></div>
              Balance
            </span>
            <span class="flex items-center">
              <div class="w-3 h-3 bg-green-400 rounded-full mr-1"></div>
              Ingresos
            </span>
            <span class="flex items-center">
              <div class="w-3 h-3 bg-red-400 rounded-full mr-1"></div>
              Gastos
            </span>
          </div>
        </div>
        
        <div class="h-96 flex items-center justify-center">
          <div *ngIf="timelineChartData" class="w-full h-full">
            <canvas baseChart
              [data]="timelineChartData"
              [type]="'line'"
              [options]="lineChartOptions">
            </canvas>
          </div>
          <div *ngIf="!timelineChartData" class="text-center text-slate-400">
            <p>No hay suficientes datos para mostrar la evolución temporal</p>
          </div>
        </div>
      </div>

      <!-- Bar Chart Full Width -->
      <div class="bg-slate-700 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-slate-200">Comparación Ingresos vs Gastos</h3>
          <span *ngIf="barChartData" 
                class="px-3 py-1 rounded-full text-sm font-medium"
                [class.bg-green-600]="balance >= 0"
                [class.text-white]="balance >= 0"
                [class.bg-red-600]="balance < 0">
            Balance: €{{ balance }}
          </span>
        </div>
        
        <div class="h-80 flex items-center justify-center">
          <div *ngIf="barChartData" class="w-full h-full">
            <canvas baseChart
              [data]="barChartData"
              [type]="'bar'"
              [options]="barChartOptions">
            </canvas>
          </div>
          <div *ngIf="!barChartData" class="text-center text-slate-400">
            <p>No hay datos suficientes para mostrar la comparación</p>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>